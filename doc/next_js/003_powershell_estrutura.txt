# Caminho base
$basePath = "C:\laragon\www\ci4_react_netx_typescript\src\public\script\my_modulo_v4\src\"

# Funcao para criar um diretorio se nao existir
function Criar-Diretorio {
    param($caminho)
    if (-not (Test-Path $caminho)) {
        New-Item -Path $caminho -ItemType Directory -Force
        Write-Host "Diretorio criado: $caminho" -ForegroundColor Green
    } else {
        Write-Host "Diretorio ja existe: $caminho" -ForegroundColor Yellow
    }
}

# Funcao para criar um arquivo se nao existir
function Criar-Arquivo {
    param($caminho, $conteudo)
    if (-not (Test-Path $caminho)) {
        New-Item -Path $caminho -ItemType File -Force
        Set-Content -Path $caminho -Value $conteudo
        Write-Host "Arquivo criado: $caminho" -ForegroundColor Green
    } else {
        Write-Host "Arquivo ja existe: $caminho" -ForegroundColor Yellow
    }
}

# NOVA FUNCAO: Para sobrescrever um arquivo mesmo se ele existir
function Sobrescrever-Arquivo {
    param($caminho, $conteudo)
    if (Test-Path $caminho) {
        Set-Content -Path $caminho -Value $conteudo -Encoding UTF8
        Write-Host "Arquivo sobrescrito: $caminho" -ForegroundColor Magenta
    } else {
        New-Item -Path $caminho -ItemType File -Force
        Set-Content -Path $caminho -Value $conteudo -Encoding UTF8
        Write-Host "Arquivo criado: $caminho" -ForegroundColor Green
    }
}

# Criacao das pastas de componentes
Criar-Diretorio "$basePath\app\about"
Criar-Diretorio "$basePath\components\Header"
Criar-Diretorio "$basePath\components\MenuNav"
Criar-Diretorio "$basePath\components\Footer"

# Criacao das pastas adicionais da estrutura moderna
Criar-Diretorio "$basePath\services"
Criar-Diretorio "$basePath\utils"
Criar-Diretorio "$basePath\hooks"
Criar-Diretorio "$basePath\context"
Criar-Diretorio "$basePath\types"
Criar-Diretorio "$basePath\styles"

# Conteudo dos arquivos

# NOVO: Declaração de tipos para Bootstrap
$bootstrapDTs = @"
declare module 'bootstrap/dist/js/bootstrap.bundle.min.js';
"@

$pageModuleCss = @"
.home {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2rem;
  text-align: center;
}

.title {
  color: #3498db;
  font-size: 2.5rem;
  margin-bottom: 1rem;
}

.description {
  color: #555;
  max-width: 800px;
  line-height: 1.6;
}
"@

# Layout com Bootstrap e componentes estruturais + fontes Geist do projeto original - CORRIGIDO
$layoutTsx = @"
'use client';

import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import 'bootstrap/dist/css/bootstrap.min.css';  // CSS do Bootstrap
import { useEffect } from 'react';
import Header from '@/components/Header/Header';
import MenuNav from '@/components/MenuNav/MenuNav';
import Footer from '@/components/Footer/Footer';
import { ThemeProvider } from '@/context/ThemeContext';

// Mantendo as fontes Geist do projeto original
const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

// Comentario: Definicao de metadata esta no arquivo separado metadata.ts

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {

  useEffect(() => {
    // Importação dinâmica correta (retorna uma Promise)
    import('bootstrap/dist/js/bootstrap.bundle.min.js')
      .then(() => {
        console.log('Bootstrap JS carregado');
      })
      .catch(err => {
        console.error('Erro ao carregar Bootstrap JS:', err);
      });
  }, []);
  
  return (
    <html lang="pt-BR">
      <body className={geistSans.variable + " " + geistMono.variable + " antialiased"}>
        <ThemeProvider>
          <div className="d-flex flex-column min-vh-100">
            <Header />
            <MenuNav />
            
            <main className="container py-4 flex-grow-1">
              {children}
            </main>
            
            <Footer />
          </div>
        </ThemeProvider>
      </body>
    </html>
  );
}
"@

# Arquivo metadata.ts separado para evitar conflito com 'use client'
$metadataTs = @"
import type { Metadata } from "next";

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};
"@

$globalsCss = @"
:root {
  --foreground-rgb: 0, 0, 0;
  --background-start-rgb: 214, 219, 220;
  --background-end-rgb: 255, 255, 255;
}

* {
  box-sizing: border-box;
  padding: 0;
  margin: 0;
}

html,
body {
  max-width: 100vw;
  min-height: 100vh;
  overflow-x: hidden;
}

a {
  color: inherit;
  text-decoration: none;
}
"@

$aboutPageTsx = @"
import styles from './page.module.css';

export default function About() {
  return (
    <div className={styles.about}>
      <h1 className={styles.title}>Sobre Nos</h1>
      <p className={styles.description}>
        Esta e a pagina Sobre, que demonstra como criar multiplas paginas no Next.js
        usando o App Router. Cada pagina tem seu proprio arquivo CSS modular.
      </p>
    </div>
  );
}
"@

$aboutPageModuleCss = @"
.about {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.title {
  color: #e74c3c;
  font-size: 2.5rem;
  border-bottom: 2px solid #e74c3c;
  padding-bottom: 0.5rem;
}

.description {
  color: #333;
  line-height: 1.6;
  background-color: #f9f9f9;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
"@

$headerTsx = @"
import styles from './Header.module.css';

export default function Header() {
  return (
    <header className={styles.header}>
      <h1>Meu Projeto Next.js</h1>
    </header>
  );
}
"@

$headerModuleCss = @"
.header {
  background-color: #2c3e50;
  color: white;
  padding: 1rem;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
"@

$menuNavTsx = @"
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import styles from './MenuNav.module.css';

export default function MenuNav() {
  const pathname = usePathname();
  
  return (
    <nav className={styles.nav}>
      <ul className={styles.navList}>
        <li className={pathname === '/' ? styles.active : ''}>
          <Link href="/">Home</Link>
        </li>
        <li className={pathname === '/about' ? styles.active : ''}>
          <Link href="/about">Sobre</Link>
        </li>
      </ul>
    </nav>
  );
}
"@

$menuNavModuleCss = @"
.nav {
  background-color: #34495e;
  padding: 0.5rem 1rem;
}

.navList {
  display: flex;
  list-style: none;
  margin: 0;
  padding: 0;
  gap: 1rem;
  justify-content: center;
}

.navList li a {
  color: white;
  text-decoration: none;
  padding: 0.5rem 1rem;
  display: block;
  transition: all 0.3s ease;
}

.navList li a:hover {
  background-color: #4a6380;
  border-radius: 4px;
}

.navList li.active a {
  background-color: #3498db;
  border-radius: 4px;
}
"@

$footerTsx = @"
import styles from './Footer.module.css';

export default function Footer() {
  return (
    <footer className={styles.footer}>
      <p>&copy; {new Date().getFullYear()} - Meu Projeto Next.js</p>
    </footer>
  );
}
"@

$footerModuleCss = @"
.footer {
  background-color: #2c3e50;
  color: white;
  padding: 1rem;
  text-align: center;
  margin-top: auto;
}
"@

$apiServiceTs = @"
/**
 * Servico para manipulacao de requisicoes API
 */
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'https://api.example.com';

export interface ApiResponse<T> {
  data?: T;
  error?: string;
  status: number;
}

/**
 * Funcao generica para fazer requisicoes a API
 */
export async function fetchApi<T>(
  endpoint: string, 
  options: RequestInit = {}
): Promise<ApiResponse<T>> {
  const url = `${API_URL}${endpoint}`;
  
  try {
    const response = await fetch(url, {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers,
      },
      ...options,
    });
    
    const data = await response.json();
    
    return {
      data: response.ok ? data : undefined,
      error: !response.ok ? data.message || 'Ocorreu um erro' : undefined,
      status: response.status,
    };
  } catch (error) {
    return {
      error: 'Erro de conexao com o servidor',
      status: 500,
    };
  }
}

export const ApiService = {
  get: <T>(endpoint: string) => fetchApi<T>(endpoint),
  
  post: <T>(endpoint: string, body: any) => fetchApi<T>(endpoint, {
    method: 'POST',
    body: JSON.stringify(body),
  }),
  
  put: <T>(endpoint: string, body: any) => fetchApi<T>(endpoint, {
    method: 'PUT',
    body: JSON.stringify(body),
  }),
  
  delete: <T>(endpoint: string) => fetchApi<T>(endpoint, {
    method: 'DELETE',
  }),
};

export default ApiService;
"@

$utilsFormatTs = @"
/**
 * Funcoes utilitarias para formatacao
 */

/**
 * Formata uma data para o formato brasileiro
 */
export const formatDate = (date: Date | string): string => {
  const dateObj = date instanceof Date ? date : new Date(date);
  return dateObj.toLocaleDateString('pt-BR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
  });
};

/**
 * Formata um valor para moeda brasileira
 */
export const formatCurrency = (value: number): string => {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  }).format(value);
};

/**
 * Trunca um texto com limite de caracteres
 */
export const truncateText = (text: string, maxLength: number): string => {
  if (text.length <= maxLength) return text;
  return `${text.slice(0, maxLength)}...`;
};
"@

$useLocalStorageTs = @"
'use client';

import { useState, useEffect } from 'react';

/**
 * Hook para persistir estado no localStorage
 */
export function useLocalStorage<T>(key: string, initialValue: T) {
  const [storedValue, setStoredValue] = useState<T>(() => {
    if (typeof window === 'undefined') {
      return initialValue;
    }
    
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.error('Error reading localStorage key:', error);
      return initialValue;
    }
  });
  
  useEffect(() => {
    if (typeof window !== 'undefined') {
      try {
        window.localStorage.setItem(key, JSON.stringify(storedValue));
      } catch (error) {
        console.error('Error setting localStorage key:', error);
      }
    }
  }, [key, storedValue]);
  
  return [storedValue, setStoredValue] as const;
}

export default useLocalStorage;
"@

$themeContextTs = @"
'use client';

import React, { createContext, useContext, useState, ReactNode } from 'react';

type Theme = 'light' | 'dark';

interface ThemeContextType {
  theme: Theme;
  toggleTheme: () => void;
}

const ThemeContext = createContext<ThemeContextType | undefined>(undefined);

export function ThemeProvider({ children }: { children: ReactNode }) {
  const [theme, setTheme] = useState<Theme>('light');

  const toggleTheme = () => {
    setTheme((prevTheme) => (prevTheme === 'light' ? 'dark' : 'light'));
  };

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      {children}
    </ThemeContext.Provider>
  );
}

export function useTheme() {
  const context = useContext(ThemeContext);
  if (context === undefined) {
    throw new Error('useTheme deve ser usado dentro de um ThemeProvider');
  }
  return context;
}
"@

$typesTs = @"
/**
 * Tipos globais da aplicacao
 */

export interface User {
  id: string;
  name: string;
  email: string;
  role: 'admin' | 'user' | 'guest';
  avatar?: string;
}

export interface PageInfo {
  currentPage: number;
  totalPages: number;
  totalItems: number;
  itemsPerPage: number;
}

export interface ApiPaginatedResponse<T> {
  data: T[];
  pageInfo: PageInfo;
}
"@

$pageTsx = @"
import styles from './page.module.css';

export default function Home() {
  return (
    <div className={styles.home}>
      <h1 className={styles.title}>Bem-vindo ao Next.js com Bootstrap</h1>
      <p className={styles.description}>
        Este e um projeto modelo usando Next.js, TypeScript e Bootstrap para criar uma aplicacao web moderna.
        A estrutura inclui componentes reutilizaveis, servicos de API, hooks customizados e muito mais.
      </p>
    </div>
  );
}
"@

# NOVO: Criar arquivo bootstrap.d.ts que resolve o problema de tipagem
Criar-Arquivo "$basePath\bootstrap.d.ts" $bootstrapDTs

# NOVO: Perguntar ao usuario se deseja sobrescrever o arquivo layout.tsx
$sobrescreverLayout = Read-Host "O arquivo layout.tsx ja existe. Deseja sobrescreve-lo? (S/N)"

# Criar arquivos normais (sem sobrescrever) - adicionamos encoding UTF8
Criar-Arquivo "$basePath\app\globals.css" $globalsCss
Criar-Arquivo "$basePath\app\page.tsx" $pageTsx
Criar-Arquivo "$basePath\app\page.module.css" $pageModuleCss
Criar-Arquivo "$basePath\app\about\page.tsx" $aboutPageTsx
Criar-Arquivo "$basePath\app\about\page.module.css" $aboutPageModuleCss
Criar-Arquivo "$basePath\components\Header\Header.tsx" $headerTsx
Criar-Arquivo "$basePath\components\Header\Header.module.css" $headerModuleCss
Criar-Arquivo "$basePath\components\MenuNav\MenuNav.tsx" $menuNavTsx
Criar-Arquivo "$basePath\components\MenuNav\MenuNav.module.css" $menuNavModuleCss
Criar-Arquivo "$basePath\components\Footer\Footer.tsx" $footerTsx
Criar-Arquivo "$basePath\components\Footer\Footer.module.css" $footerModuleCss
Criar-Arquivo "$basePath\services\api.service.ts" $apiServiceTs
Criar-Arquivo "$basePath\utils\format.ts" $utilsFormatTs
Criar-Arquivo "$basePath\hooks\useLocalStorage.ts" $useLocalStorageTs
Criar-Arquivo "$basePath\context\ThemeContext.tsx" $themeContextTs
Criar-Arquivo "$basePath\types\index.ts" $typesTs
Criar-Arquivo "$basePath\app\metadata.ts" $metadataTs

# Decidir se sobrescreve o layout.tsx
if ($sobrescreverLayout -eq "S" -or $sobrescreverLayout -eq "s") {
    Sobrescrever-Arquivo "$basePath\app\layout.tsx" $layoutTsx
    Write-Host "O arquivo layout.tsx foi atualizado com as configuracoes de Bootstrap e componentes estruturais." -ForegroundColor Green
} else {
    Write-Host "O arquivo layout.tsx nao foi alterado." -ForegroundColor Yellow
    Write-Host "Para usar Bootstrap e os componentes estruturais, voce precisara atualizar manualmente o arquivo layout.tsx." -ForegroundColor Yellow
}

Write-Host "`nEstrutura completa criada com sucesso!" -ForegroundColor Cyan
Write-Host "Para usar o Bootstrap, execute o seguinte comando:" -ForegroundColor Yellow
Write-Host "npm install bootstrap" -ForegroundColor Green
Write-Host "`nPara visualizar o projeto, execute 'npm run dev' no diretorio raiz do projeto." -ForegroundColor Cyan
Write-Host "`nO arquivo bootstrap.d.ts foi adicionado para resolver o problema de tipagem do Bootstrap." -ForegroundColor Green